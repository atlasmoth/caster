name: Deploy to DigitalOcean

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_API_TOKEN }}

      - name: Setup files
        run: |
          touch backend/.env
          echo "${{ secrets.ENV}}" | base64 -d > backend/.env
      - name: Copy files to droplet
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: root
          password: ${{ secrets.SSH_STAGING_PASSWORD }}
          source: "./backend/."
          target: "/root/sample"

      # - name: Deploy to DigitalOcean
      #   uses: appleboy/ssh-action@master
      #   with:
      #     host: ${{ secrets.STAGING_HOST }}
      #     username: root
      #     password: ${{ secrets.SSH_STAGING_PASSWORD }}
      #     script: |
      #       cd /root/caster
      #       docker-compose -f dev-docker-compose.yml down
      #       docker-compose -f dev-docker-compose.yml up --build -d
      #       # Wait for the containers to be fully up and running
      #       while ! docker-compose -f dev-docker-compose.yml ps | grep 'Up'; do
      #         echo "Waiting for containers to be up..."
      #         sleep 5
      #       done
      #       echo "Containers are up and running!"
